<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>daegon charts</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/jaBZ19n.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        :root {
            --primary: #F9FAFB;
            --secondary: #111827;
            --accent: #00CED1;
            --accent-dark: #008B8B;
            --gold: #FFD700;
            --silver: #C0C0C0;
            --bronze: #CD7F32;
            --header-blue: #1e3a8a;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary);
            color: var(--secondary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .loader {
            border: 4px solid rgba(17, 24, 39, 0.1);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chart-nav-btn.active {
            background-color: var(--accent);
            color: var(--secondary);
        }
        .chart-nav-btn.goat-active {
            background-color: var(--gold);
            color: var(--secondary);
        }
        .section-title {
            position: relative;
            display: inline-block;
            margin-bottom: 2rem;
            color: var(--secondary);
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 50px;
            height: 3px;
            background: var(--accent);
        }
        .artist-link {
            cursor: pointer;
            transition: color 0.2s;
        }
        .artist-link:hover {
            color: var(--accent);
        }
        .artist-page-link {
            cursor: pointer;
        }
        .artist-page-link:hover {
            color: var(--accent);
        }
        .year-selector {
            background: rgba(0, 206, 209, 0.1);
            border-radius: 8px;
            padding: 0.5rem;
        }
        .year-btn {
            transition: all 0.2s ease;
        }
        .year-btn.active {
            background: var(--accent);
            color: white;
        }
        .top-card {
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .item-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .item-details-modal.active {
            opacity: 1;
            pointer-events: all;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            padding: 2rem;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .item-details-modal.active .modal-content {
            transform: translateY(0);
        }
        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--secondary);
        }
        .bottom-nav {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        .search-container {
            position: relative;
            margin-bottom: 1rem;
        }
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }
        .flatpickr-input {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 150px;
            text-align: center;
        }

        /* LAYOUT DO CHART SEMANAL MELHORADO */
        .chart-container {
            position: relative;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .chart-header {
            background-color: var(--header-blue);
            color: white;
            padding: 16px 20px;
            font-weight: bold;
            font-size: 15px;
            display: grid;
            grid-template-columns: 100px 1fr 100px 100px 100px;
            gap: 16px;
            align-items: center;
        }

        .chart-header div:nth-child(2) {
            color: var(--header-blue);
        }

        .chart-row-weekly {
            display: grid;
            grid-template-columns: 100px 1fr 100px 100px 100px;
            gap: 16px;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s ease;
            min-height: 70px;
        }

        .chart-row-weekly:nth-child(even) {
            background-color: #f9fafb;
        }

        .chart-row-weekly:nth-child(odd) {
            background-color: white;
        }

        .position-diff-cell {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: flex-start;
        }

        .position-number {
            font-weight: bold;
            font-size: 18px;
            min-width: 35px;
            text-align: center;
        }

        .image-cell {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chart-image {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
        }

        .diff-indicator {
            font-size: 12px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 6px;
            min-width: 40px;
            text-align: center;
        }

        .diff-new {
            background-color: var(--accent);
            color: white;
        }

        .diff-up {
            background-color: #10b981;
            color: white;
        }

        .diff-down {
            background-color: #ef4444;
            color: white;
        }

        .diff-re {
            background-color: #8b5cf6;
            color: white;
        }

        .diff-equal {
            background-color: #6b7280;
            color: white;
        }

        .info-cell {
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .track-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .artist-name {
            font-size: 14px;
            color: #6b7280;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .units-cell, .lastweek-cell, .peak-cell, .weeks-cell {
            text-align: center;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }

        .units-value {
            font-weight: bold;
            color: #111827;
            margin-bottom: 2px;
        }

        .total-units {
            font-size: 12px;
            color: #6b7280;
        }

        .certification {
            font-size: 12px;
            color: #dc2626;
            font-weight: bold;
            margin-top: 2px;
        }

        /* PRIMEIRA POSIÇÃO DESTACADA */
        .first-position {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(0, 206, 209, 0.1) 0%, rgba(0, 206, 209, 0.05) 100%);
            border: 2px solid var(--accent);
            border-radius: 8px;
            margin: 12px;
            padding: 20px;
            display: grid;
            grid-template-columns: 120px 1fr 120px 120px 120px;
            gap: 20px;
            align-items: center;
            min-height: 90px;
        }

        .first-position .position-number {
            font-size: 28px;
            color: var(--accent);
        }

        .first-position .chart-image {
            width: 70px;
            height: 70px;
        }

        .first-position .track-name {
            font-size: 20px;
        }

        .first-position .artist-name {
            font-size: 16px;
        }

        .award-star {
            color: #000;
            font-size: 18px;
            margin-left: 6px;
        }

        .chart-run-mini {
            display: flex;
            height: 8px;
            margin-top: 8px;
            gap: 3px;
            background: #f3f4f6;
            padding: 3px;
            border-radius: 4px;
        }

        .chart-run-bar {
            flex: 1;
            background: #e5e7eb;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .chart-run-bar.active {
            background: var(--accent);
        }

        .chart-run-bar.peak {
            background: var(--gold);
        }

        .chart-run-bar:hover {
            transform: scaleY(1.5);
        }

        /* LAYOUT PARA YEAR-END E GOAT COM IMAGENS */
        .chart-row-with-image {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            gap: 20px;
            min-height: 70px;
        }

        .chart-row-with-image:nth-child(even) {
            background-color: #f9fafb;
        }

        .chart-image-small {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .chart-info-expanded {
            flex: 1;
            min-width: 0;
        }

        .badge {
            font-size: 11px;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .badge-new-peak {
            background-color: #fcd34d;
            color: #000;
        }

        .badge-weeks-at-1 {
            background-color: #3b82f6;
            color: #fff;
        }

        /* PÁGINA DO ARTISTA */
        .artist-page {
            max-width: 6xl;
            margin: 0 auto;
        }

        .artist-header {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 40px;
            padding: 30px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .artist-image-large {
            width: 150px;
            height: 150px;
            border-radius: 16px;
            object-fit: cover;
        }

        .artist-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 1rem;
            color: #6b7280;
            font-weight: 600;
        }

        .artist-chart-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .chart-item:last-child {
            border-bottom: none;
        }

        /* Estilos responsivos */
        @media (max-width: 768px) {
            .chart-header,
            .chart-row-weekly,
            .first-position {
                grid-template-columns: 60px 1fr 80px;
                gap: 10px;
                font-size: 12px;
            }
            
            .chart-header div:nth-child(4),
            .chart-header div:nth-child(5),
            .chart-row-weekly > div:nth-child(4),
            .chart-row-weekly > div:nth-child(5),
            .first-position > div:nth-child(4),
            .first-position > div:nth-child(5) {
                display: none;
            }
            
            .position-number {
                font-size: 14px;
            }
            
            .track-name {
                font-size: 14px;
            }
            
            .artist-name {
                font-size: 12px;
            }
            
            .chart-row-with-image {
                flex-direction: column;
                text-align: center;
                gap: 10px;
                padding: 12px;
            }
            
            .chart-info-expanded {
                width: 100%;
            }
            
            .artist-header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
                padding: 20px;
            }
            
            .artist-image-large {
                width: 120px;
                height: 120px;
            }
            
            .artist-stats {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .chart-header,
            .chart-row-weekly,
            .first-position {
                grid-template-columns: 50px 1fr 70px;
                gap: 8px;
                font-size: 11px;
                padding: 12px;
            }
            
            .position-number {
                font-size: 12px;
            }
            
            .track-name {
                font-size: 12px;
            }
            
            .artist-name {
                font-size: 10px;
            }
            
            .chart-image {
                width: 40px;
                height: 40px;
            }
            
            .first-position {
                padding: 15px;
                grid-template-columns: 80px 1fr 80px;
            }
            
            .first-position .chart-image {
                width: 50px;
                height: 50px;
            }
            
            .first-position .track-name {
                font-size: 16px;
            }
            
            .first-position .artist-name {
                font-size: 14px;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <header class="bg-white border-b border-gray-200 sticky top-0 z-20 shadow-sm">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl md:text-3xl font-extrabold">
                <span class="gradient-text cursor-pointer" id="mainTitle">daegon charts</span>
            </h1>
            <nav class="flex space-x-4">
                <button id="navAllEntries" class="text-sm font-semibold text-gray-700 hover:text-accent transition-colors">
                    All Entries
                </button>
                <button id="navChartBeat" class="text-sm font-semibold text-gray-700 hover:text-accent transition-colors">
                    Chart Beat
                </button>
            </nav>
        </div>
    </header>

    <main id="app" class="flex-grow container mx-auto p-4 md:p-6">
    </main>

    <footer class="bg-white mt-8 py-6 border-t border-gray-200">
        <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
            <p>Chart generated based on dantaswt's Last.fm data</p>
            <p class="mt-2">Developed with <i class="fas fa-heart text-red-500"></i> using HTML, CSS & JavaScript</p>
        </div>
    </footer>

    <div class="item-details-modal" id="itemDetailsModal">
        <div class="modal-content w-full max-w-2xl">
            <button class="close-modal" id="closeModal">×</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÕES E ESTADO ---
        const SPOTIFY_CLIENT_ID = '60d65b0ac9f14d6aa91c08a66894cea9';
        const SPOTIFY_CLIENT_SECRET = 'caf3f20ae798475e8dec65697f210c2a';
        let SPOTIFY_ACCESS_TOKEN = '';
        let imageCache = {};
        let isLoading = false;
        let flatpickrInstance = null;

        const chartsConfig = {
            songs: { url: 'https://docs.google.com/spreadsheets/d/1t6_7SOlspmNYrXq8PSfJ74frIdrWwQBFITQ3bQmRzeg/export?format=csv&gid=904867620', title: 'Hot 100', icon: 'fa-music' },
            artists: { url: 'https://docs.google.com/spreadsheets/d/1t6_7SOlspmNYrXq8PSfJ74frIdrWwQBFITQ3bQmRzeg/export?format=csv&gid=1568177610', title: 'Artist 50', icon: 'fa-user' },
            albums: { url: 'https://docs.google.com/spreadsheets/d/1t6_7SOlspmNYrXq8PSfJ74frIdrWwQBFITQ3bQmRzeg/export?format=csv&gid=1940039611', title: 'Top 100 Albums', icon: 'fa-compact-disc' },
            yearEndSongs: { url: 'https://docs.google.com/spreadsheets/d/1t6_7SOlspmNYrXq8PSfJ74frIdrWwQBFITQ3bQmRzeg/export?format=csv&gid=530686468', title: 'Year-End Songs', icon: 'fa-calendar' },
            yearEndArtists: { url: 'https://docs.google.com/spreadsheets/d/1t6_7SOlspmNYrXq8PSfJ74frIdrWwQBFITQ3bQmRzeg/export?format=csv&gid=1597569311', title: 'Year-End Artists', icon: 'fa-calendar' },
            yearEndAlbums: { url: 'https://docs.google.com/spreadsheets/d/1t6_7SOlspmNYrXq8PSfJ74frIdrWwQBFITQ3bQmRzeg/export?format=csv&gid=897935603', title: 'Year-End Albums', icon: 'fa-calendar' },
            goatSongs: { url: 'https://docs.google.com/spreadsheets/d/1t6_7SOlspmNYrXq8PSfJ74frIdrWwQBFITQ3bQmRzeg/export?format=csv&gid=1157278896', title: 'GOAT Songs', icon: 'fa-trophy' },
            goatArtists: { url: 'https://docs.google.com/spreadsheets/d/1t6_7SOlspmNYrXq8PSfJ74frIdrWwQBFITQ3bQmRzeg/export?format=csv&gid=222299678', title: 'GOAT Artists', icon: 'fa-trophy' },
            goatAlbums: { url: 'https://docs.google.com/spreadsheets/d/1t6_7SOlspmNYrXq8PSfJ74frIdrWwQBFITQ3bQmRzeg/export?format=csv&gid=1548244755', title: 'GOAT Albums', icon: 'fa-trophy' },
            artistStats: { url: 'https://docs.google.com/spreadsheets/d/1t6_7SOlspmNYrXq8PSfJ74frIdrWwQBFITQ3bQmRzeg/export?format=csv&gid=1519606558', title: 'Artist Statistics', icon: 'fa-chart-bar' }
        };

        let appState = {
            activeChart: 'songs',
            chartData: {},
            currentDate: null,
            currentView: 'home',
            currentArtist: null,
            currentYear: new Date().getFullYear().toString(),
            colMaps: {},
            top3Data: {},
            artistDetailsData: {},
            chartRunData: {},
            allEntries: { songs: [], artists: [], albums: [] },
            currentBlog: 'hot100',
            sharedDate: null,
            navigationHistory: [],
            loadedCharts: new Set(),
            availableDates: [],
            syncDate: null,
            artistStatsData: {}
        };

        // --- ELEMENTOS DOM ---
        const appContainer = document.getElementById('app');
        const itemDetailsModal = document.getElementById('itemDetailsModal');
        const modalContent = document.getElementById('modalContent');
        const closeModal = document.getElementById('closeModal');

        // --- FUNÇÕES OTIMIZADAS ---
        async function getSpotifyAccessToken() {
            if (SPOTIFY_ACCESS_TOKEN) return SPOTIFY_ACCESS_TOKEN;
            
            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(SPOTIFY_CLIENT_ID + ':' + SPOTIFY_CLIENT_SECRET)
                    },
                    body: 'grant_type=client_credentials'
                });
                
                const data = await response.json();
                SPOTIFY_ACCESS_TOKEN = data.access_token;
                return SPOTIFY_ACCESS_TOKEN;
            } catch (error) {
                console.error('Error getting Spotify token:', error);
                return null;
            }
        }

        async function getSpotifyImage(query, type, albumQuery = null) {
            const cacheKey = albumQuery ? `${type}:${albumQuery}` : `${type}:${query}`;
            if (imageCache[cacheKey]) return imageCache[cacheKey];
            
            const token = await getSpotifyAccessToken();
            if (!token) return null;
            
            try {
                let searchQuery = query;
                let searchType = type === 'artist' ? 'artist' : 'album';
                
                if (type === 'album' && albumQuery) {
                    searchQuery = albumQuery;
                }
                
                const response = await fetch(
                    `https://api.spotify.com/v1/search?q=${encodeURIComponent(searchQuery)}&type=${searchType}&limit=3`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                
                const data = await response.json();
                let imageUrl = null;
                
                if (searchType === 'artist' && data.artists?.items?.[0]?.images?.[0]?.url) {
                    imageUrl = data.artists.items[0].images[0].url;
                } else if (searchType === 'album' && data.albums?.items?.[0]?.images?.[0]?.url) {
                    imageUrl = data.albums.items[0].images[0].url;
                }
                
                if (imageUrl) imageCache[cacheKey] = imageUrl;
                return imageUrl;
            } catch (error) {
                return null;
            }
        }

        async function loadAllCardImages() {
            const cardTypes = ['songs', 'artists', 'albums', 'yearEndSongs', 'yearEndArtists', 'yearEndAlbums', 'goatSongs', 'goatArtists', 'goatAlbums'];
            
            for (const chartType of cardTypes) {
                const topItem = appState.top3Data[chartType]?.[0];
                if (!topItem || !topItem.name || topItem.name === 'Unknown') continue;
                
                let query = '';
                let type = '';
                let albumQuery = null;
                
                if (chartType.includes('Songs') || chartType === 'songs') {
                    query = topItem.artist;
                    type = 'artist';
                } else if (chartType.includes('Albums') || chartType === 'albums') {
                    query = topItem.artist;
                    type = 'album';
                    albumQuery = `${topItem.artist} ${topItem.name}`;
                } else if (chartType.includes('Artists') || chartType === 'artists') {
                    query = topItem.name;
                    type = 'artist';
                } else if (chartType.includes('goatSongs')) {
                    query = topItem.artist;
                    type = 'artist';
                } else if (chartType.includes('goatAlbums')) {
                    query = topItem.artist;
                    type = 'album';
                    albumQuery = `${topItem.artist} ${topItem.name}`;
                } else if (chartType.includes('goatArtists')) {
                    query = topItem.name;
                    type = 'artist';
                } else if (chartType.includes('yearEndSongs')) {
                    query = topItem.artist;
                    type = 'artist';
                } else if (chartType.includes('yearEndAlbums')) {
                    query = topItem.artist;
                    type = 'album';
                    albumQuery = `${topItem.artist} ${topItem.name}`;
                } else if (chartType.includes('yearEndArtists')) {
                    query = topItem.name;
                    type = 'artist';
                }
                
                if (query && query !== 'Unknown') {
                    try {
                        const imageUrl = await getSpotifyImage(query, type, albumQuery);
                        const imageElement = document.getElementById(`top-image-${chartType}`);
                        
                        if (imageElement && imageUrl) {
                            imageElement.innerHTML = `<img src="${imageUrl}" alt="${query}" class="w-full h-full object-cover">`;
                            imageElement.classList.remove('placeholder-art');
                        }
                    } catch (error) {
                        console.error('Error loading card image:', error);
                    }
                }
            }
        }

        function showMessage(type, text) {
            if (!appContainer) return;
            
            let html = '';
            if (type === 'loading') {
                html = `
                    <div class="flex flex-col items-center justify-center p-8 text-secondary">
                        <div class="loader mb-4"></div>
                        <p class="text-gray-500">${text}</p>
                    </div>
                `;
            } else if (type === 'error') {
                html = `
                    <div class="flex flex-col items-center justify-center p-8 text-secondary">
                        <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                        <p class="text-center text-red-500 font-semibold">${text}</p>
                        <button id="retryButton" class="mt-4 px-4 py-2 bg-accent text-secondary rounded-md hover:bg-accent-dark transition-colors">
                            Try Again
                        </button>
                    </div>
                `;
            }
            
            appContainer.innerHTML = html;
            
            if (type === 'error') {
                document.getElementById('retryButton')?.addEventListener('click', initializeApp);
            }
        }

        function parseCsvRow(text) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        async function fetchChartData(chartType) {
            if (appState.loadedCharts.has(chartType)) return true;
            
            const config = chartsConfig[chartType];
            if (!config) return false;

            try {
                const response = await fetch(`${config.url}&_=${Date.now()}`);
                if (!response.ok) throw new Error(`Failed to load ${config.title}`);
                
                let csvText = await response.text();
                if (csvText.charCodeAt(0) === 0xFEFF) csvText = csvText.substring(1);

                const rows = csvText.trim().split('\n').map(row => parseCsvRow(row));
                if (rows.length < 2) throw new Error('Not enough data');

                await processChartData(chartType, rows);
                appState.loadedCharts.add(chartType);
                return true;
            } catch (error) {
                console.error(`Error loading ${chartType}:`, error);
                return false;
            }
        }

        async function fetchArtistStats() {
            try {
                const response = await fetch(`${chartsConfig.artistStats.url}&_=${Date.now()}`);
                if (!response.ok) throw new Error('Failed to load artist statistics');
                
                let csvText = await response.text();
                if (csvText.charCodeAt(0) === 0xFEFF) csvText = csvText.substring(1);

                const rows = csvText.trim().split('\n').map(row => parseCsvRow(row));
                if (rows.length < 2) throw new Error('Not enough artist data');

                const header = rows[0].map(h => h.toLowerCase().trim());
                const data = rows.slice(1);
                
                const colMap = {
                    artist: findIndex(header, ['artist', 'artists']),
                    chart: findIndex(header, ['chart']),
                    item: findIndex(header, ['item']),
                    peak: findIndex(header, ['peak']),
                    weeks: findIndex(header, ['weeks']),
                    totalUnits: findIndex(header, ['total units'])
                };

                appState.artistStatsData = {};
                
                data.forEach(row => {
                    const artist = row[colMap.artist];
                    const chart = row[colMap.chart];
                    const item = row[colMap.item];
                    const peak = parseInt(row[colMap.peak]) || 0;
                    const weeks = parseInt(row[colMap.weeks]) || 0;
                    const totalUnits = row[colMap.totalUnits] || '0';

                    if (!artist) return;

                    if (!appState.artistStatsData[artist]) {
                        appState.artistStatsData[artist] = {
                            'Hot 100 Songs': { entries: [], count: 0, numberOnes: 0, topTens: 0, totalUnits: 0 },
                            'Top 100 Albums': { entries: [], count: 0, numberOnes: 0, topTens: 0, totalUnits: 0 },
                            'Artist 50': { entries: [], count: 0, numberOnes: 0, topTens: 0, totalUnits: 0 }
                        };
                    }

                    if (appState.artistStatsData[artist][chart]) {
                        const entry = {
                            item: item,
                            peak: peak,
                            weeks: weeks,
                            totalUnits: totalUnits
                        };
                        
                        appState.artistStatsData[artist][chart].entries.push(entry);
                        appState.artistStatsData[artist][chart].count++;
                        
                        if (peak === 1) appState.artistStatsData[artist][chart].numberOnes++;
                        if (peak <= 10) appState.artistStatsData[artist][chart].topTens++;
                        
                        const units = parseFloat(totalUnits) || 0;
                        appState.artistStatsData[artist][chart].totalUnits += units;
                    }
                });

                return true;
            } catch (error) {
                console.error('Error loading artist stats:', error);
                return false;
            }
        }

        async function processChartData(chartType, rows) {
            const header = rows[0].map(h => h.toLowerCase().trim());
            const data = rows.slice(1);
            
            const colMap = {
                date: findIndex(header, ['date', 'chart date']),
                position: findIndex(header, ['position', 'rank', 'pos']),
                diff: findIndex(header, ['dif', 'diff', '▲▼']),
                song: findIndex(header, ['song', 'title', 'track']),
                album: findIndex(header, ['album']),
                artist: findIndex(header, ['artist', 'artists']),
                lastWeek: findIndex(header, ['last week', 'lw']),
                peak: findIndex(header, ['peak']),
                weeks: findIndex(header, ['weeks', 'wks']),
                weeksAt1: findIndex(header, ['weeks at 1', 'wks at 1']),
                units: findIndex(header, ['units']),
                totalUnits: findIndex(header, ['total units']),
                certification: findIndex(header, ['certification']),
                year: findIndex(header, ['year', 'ano'])
            };
            
            appState.colMaps[chartType] = colMap;

            if (chartType.includes('yearEnd')) {
                processYearEndData(chartType, data, colMap);
            } else if (chartType.includes('goat')) {
                processGoatData(chartType, data, colMap);
            } else {
                processWeeklyData(chartType, data, colMap);
            }
        }

        function processWeeklyData(chartType, data, colMap) {
            const chartData = {};
            const allEntries = [];
            const chartRunData = {};
            const top3Data = {};
            const availableDates = new Set();

            data.forEach(row => {
                const date = row[colMap.date];
                if (!date) return;
                
                availableDates.add(date);
                
                const position = parseInt(row[colMap.position]) || 0;
                if (position < 1 || position > 100) return;
                
                const diff = row[colMap.diff] || '';
                const song = row[colMap.song] || 'Unknown';
                const album = row[colMap.album] || '';
                const artist = row[colMap.artist] || 'Unknown';
                const lastWeek = parseInt(row[colMap.lastWeek]) || 0;
                const peak = parseInt(row[colMap.peak]) || position;
                const weeks = parseInt(row[colMap.weeks]) || 1;
                const weeksAt1 = parseInt(row[colMap.weeksAt1]) || 0;
                const units = row[colMap.units] || '';
                const totalUnits = row[colMap.totalUnits] || '';
                const certification = row[colMap.certification] || '';

                if (!chartData[date]) chartData[date] = [];
                chartData[date].push({
                    position, diff, song, album, artist, lastWeek, peak, weeks, weeksAt1, units, totalUnits, certification
                });

                allEntries.push({
                    date, position, diff, song, album, artist, lastWeek, peak, weeks, weeksAt1, units, totalUnits, certification
                });

                if (!chartRunData[song]) chartRunData[song] = {};
                chartRunData[song][date] = position;
            });

            appState.chartData[chartType] = chartData;
            appState.allEntries[chartType] = allEntries;
            appState.chartRunData[chartType] = chartRunData;
            appState.availableDates = Array.from(availableDates).sort().reverse();

            if (appState.availableDates.length > 0 && !appState.currentDate) {
                appState.currentDate = appState.availableDates[0];
            }

            updateTop3Data(chartType);
        }

        function processYearEndData(chartType, data, colMap) {
            const chartData = {};
            const top3Data = {};

            data.forEach(row => {
                const year = row[colMap.year] || new Date().getFullYear().toString();
                const position = parseInt(row[colMap.position]) || 0;
                if (position < 1) return;
                
                const song = row[colMap.song] || 'Unknown';
                const album = row[colMap.album] || '';
                const artist = row[colMap.artist] || 'Unknown';
                const totalUnits = row[colMap.totalUnits] || '';
                const certification = row[colMap.certification] || '';

                if (!chartData[year]) chartData[year] = [];
                chartData[year].push({
                    position, song, album, artist, totalUnits, certification
                });
            });

            appState.chartData[chartType] = chartData;
            updateYearEndTop3Data(chartType);
        }

        function processGoatData(chartType, data, colMap) {
            const chartData = {};
            const top3Data = {};

            data.forEach(row => {
                const position = parseInt(row[colMap.position]) || 0;
                if (position < 1) return;
                
                const song = row[colMap.song] || 'Unknown';
                const album = row[colMap.album] || '';
                const artist = row[colMap.artist] || 'Unknown';
                const totalUnits = row[colMap.totalUnits] || '';
                const certification = row[colMap.certification] || '';

                if (!chartData['allTime']) chartData['allTime'] = [];
                chartData['allTime'].push({
                    position, song, album, artist, totalUnits, certification
                });
            });

            appState.chartData[chartType] = chartData;
            updateGoatTop3Data(chartType);
        }

        function updateTop3Data(chartType) {
            if (!appState.currentDate || !appState.chartData[chartType]?.[appState.currentDate]) return;
            
            const currentData = appState.chartData[chartType][appState.currentDate];
            appState.top3Data[chartType] = currentData.slice(0, 3);
        }

        function updateYearEndTop3Data(chartType) {
            if (!appState.chartData[chartType]?.[appState.currentYear]) return;
            
            const currentData = appState.chartData[chartType][appState.currentYear];
            appState.top3Data[chartType] = currentData.slice(0, 3);
        }

        function updateGoatTop3Data(chartType) {
            if (!appState.chartData[chartType]?.['allTime']) return;
            
            const currentData = appState.chartData[chartType]['allTime'];
            appState.top3Data[chartType] = currentData.slice(0, 3);
        }

        function findIndex(header, possibleNames) {
            for (const name of possibleNames) {
                const index = header.indexOf(name);
                if (index !== -1) return index;
            }
            return -1;
        }

        function formatDiff(diff) {
            if (!diff || diff === '-') return { text: '-', type: 'equal' };
            
            const cleanDiff = diff.replace('▲', '').replace('▼', '').replace('RE', '').trim();
            
            if (diff.includes('NEW')) return { text: 'NEW', type: 'new' };
            if (diff.includes('RE')) return { text: `RE-${cleanDiff}`, type: 're' };
            if (diff.includes('▲')) return { text: `+${cleanDiff}`, type: 'up' };
            if (diff.includes('▼')) return { text: `-${cleanDiff}`, type: 'down' };
            
            return { text: diff, type: 'equal' };
        }

        function formatUnits(units) {
            if (!units) return '';
            if (typeof units === 'number') return units.toLocaleString();
            return units;
        }

        function formatChartRun(chartRun) {
            if (!chartRun || Object.keys(chartRun).length === 0) return '';
            
            const dates = Object.keys(chartRun).sort();
            const positions = dates.map(date => chartRun[date]);
            const minPosition = Math.min(...positions);
            
            let html = '<div class="chart-run-mini">';
            positions.forEach((pos, i) => {
                const isPeak = pos === minPosition;
                const isActive = i === positions.length - 1;
                html += `<div class="chart-run-bar ${isActive ? 'active' : ''} ${isPeak ? 'peak' : ''}" title="Week ${i+1}: #${pos}"></div>`;
            });
            html += '</div>';
            return html;
        }

        function getChartRunForItem(chartType, itemName) {
            if (!appState.chartRunData[chartType] || !appState.chartRunData[chartType][itemName]) return null;
            return appState.chartRunData[chartType][itemName];
        }

        function navigateTo(view, params = {}) {
            appState.navigationHistory.push({ view: appState.currentView, params: { ...appState } });
            appState.currentView = view;
            
            if (params.chartType) appState.activeChart = params.chartType;
            if (params.artist) appState.currentArtist = params.artist;
            if (params.blog) appState.currentBlog = params.blog;
            if (params.date) appState.currentDate = params.date;
            if (params.year) appState.currentYear = params.year;
            
            renderView();
        }

        function navigateBack() {
            if (appState.navigationHistory.length === 0) return;
            const previousState = appState.navigationHistory.pop();
            appState.currentView = previousState.view;
            Object.assign(appState, previousState.params);
            renderView();
        }

        function renderView() {
            switch (appState.currentView) {
                case 'home':
                    renderHomePage();
                    break;
                case 'chart':
                    renderChartPage();
                    break;
                case 'artist':
                    renderArtistPage();
                    break;
                case 'allEntries':
                    renderAllEntriesPage();
                    break;
                case 'chartBeat':
                    renderChartBeatPage();
                    break;
            }
        }

        function renderHomePage() {
            const html = `
                <div class="mb-8">
                    <h2 class="text-3xl font-bold mb-2">Welcome to daegon charts</h2>
                    <p class="text-gray-600">Your ultimate source for music chart statistics based on Last.fm data</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold">Weekly Charts</h3>
                            <i class="fas fa-calendar-week text-accent text-2xl"></i>
                        </div>
                        <p class="text-gray-600 mb-4">Current week's top songs, artists, and albums</p>
                        <div class="space-y-3">
                            <button class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex items-center justify-between" onclick="navigateTo('chart', { chartType: 'songs' })">
                                <span>Hot 100</span>
                                <i class="fas fa-chevron-right text-gray-400"></i>
                            </button>
                            <button class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex items-center justify-between" onclick="navigateTo('chart', { chartType: 'artists' })">
                                <span>Artist 50</span>
                                <i class="fas fa-chevron-right text-gray-400"></i>
                            </button>
                            <button class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex items-center justify-between" onclick="navigateTo('chart', { chartType: 'albums' })">
                                <span>Top 100 Albums</span>
                                <i class="fas fa-chevron-right text-gray-400"></i>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold">Year-End Charts</h3>
                            <i class="fas fa-calendar-alt text-accent text-2xl"></i>
                        </div>
                        <p class="text-gray-600 mb-4">Best performing songs, artists, and albums of the year</p>
                        <div class="space-y-3">
                            <button class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex items-center justify-between" onclick="navigateTo('chart', { chartType: 'yearEndSongs' })">
                                <span>Year-End Songs</span>
                                <i class="fas fa-chevron-right text-gray-400"></i>
                            </button>
                            <button class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex items-center justify-between" onclick="navigateTo('chart', { chartType: 'yearEndArtists' })">
                                <span>Year-End Artists</span>
                                <i class="fas fa-chevron-right text-gray-400"></i>
                            </button>
                            <button class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex items-center justify-between" onclick="navigateTo('chart', { chartType: 'yearEndAlbums' })">
                                <span>Year-End Albums</span>
                                <i class="fas fa-chevron-right text-gray-400"></i>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold">Greatest of All Time</h3>
                            <i class="fas fa-trophy text-accent text-2xl"></i>
                        </div>
                        <p class="text-gray-600 mb-4">All-time top songs, artists, and albums</p>
                        <div class="space-y-3">
                            <button class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex items-center justify-between" onclick="navigateTo('chart', { chartType: 'goatSongs' })">
                                <span>GOAT Songs</span>
                                <i class="fas fa-chevron-right text-gray-400"></i>
                            </button>
                            <button class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex items-center justify-between" onclick="navigateTo('chart', { chartType: 'goatArtists' })">
                                <span>GOAT Artists</span>
                                <i class="fas fa-chevron-right text-gray-400"></i>
                            </button>
                            <button class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex items-center justify-between" onclick="navigateTo('chart', { chartType: 'goatAlbums' })">
                                <span>GOAT Albums</span>
                                <i class="fas fa-chevron-right text-gray-400"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">Quick Actions</h3>
                        <i class="fas fa-bolt text-accent text-2xl"></i>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button class="p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex items-center" onclick="navigateTo('allEntries')">
                            <i class="fas fa-list text-accent text-xl mr-3"></i>
                            <div>
                                <div class="font-semibold">All Entries</div>
                                <div class="text-sm text-gray-600">Browse all chart entries</div>
                            </div>
                        </button>
                        <button class="p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex items-center" onclick="navigateTo('chartBeat')">
                            <i class="fas fa-chart-bar text-accent text-xl mr-3"></i>
                            <div>
                                <div class="font-semibold">Chart Beat</div>
                                <div class="text-sm text-gray-600">Statistics and insights</div>
                            </div>
                        </button>
                    </div>
                </div>
            `;
            
            appContainer.innerHTML = html;
        }

        function renderChartPage() {
            const chartType = appState.activeChart;
            const config = chartsConfig[chartType];
            if (!config) return;

            let html = `
                <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-bold flex items-center">
                            <i class="fas ${config.icon} mr-3 text-accent"></i>
                            ${config.title}
                        </h2>
                        ${chartType.includes('yearEnd') ? `
                            <div class="mt-2 year-selector inline-flex items-center">
                                <span class="mr-3 text-gray-600">Year:</span>
                                <div class="flex space-x-1">
                                    ${['2024', '2023', '2022'].map(year => `
                                        <button class="year-btn px-3 py-1 rounded-md ${appState.currentYear === year ? 'active' : ''}" onclick="changeYear('${year}')">
                                            ${year}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        ${!chartType.includes('goat') && !chartType.includes('yearEnd') ? `
                            <div class="flex items-center space-x-2">
                                <button id="prevDate" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                
                                <div class="relative">
                                    <input type="text" id="datePicker" class="flatpickr-input" placeholder="Select date" readonly>
                                </div>
                                
                                <button id="nextDate" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        ` : ''}
                        
                        <button onclick="navigateTo('home')" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                            <i class="fas fa-home"></i>
                        </button>
                    </div>
                </div>
            `;

            if (chartType.includes('yearEnd') || chartType.includes('goat')) {
                html += renderYearEndOrGoatChart(chartType);
            } else {
                html += renderWeeklyChart(chartType);
            }

            html += `
                <div class="bottom-nav flex justify-between items-center mt-8 pt-4 border-t border-gray-200">
                    <button onclick="navigateTo('home')" class="flex items-center text-accent hover:text-accent-dark transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Home
                    </button>
                    
                    <div class="flex space-x-2">
                        <button onclick="navigateTo('allEntries')" class="flex items-center text-gray-600 hover:text-gray-800 transition-colors">
                            <i class="fas fa-list mr-2"></i>
                            All Entries
                        </button>
                        <button onclick="navigateTo('chartBeat')" class="flex items-center text-gray-600 hover:text-gray-800 transition-colors">
                            <i class="fas fa-chart-bar mr-2"></i>
                            Chart Beat
                        </button>
                    </div>
                </div>
            `;

            appContainer.innerHTML = html;

            if (!chartType.includes('goat') && !chartType.includes('yearEnd')) {
                initializeDatePicker();
                setupDateNavigation();
            }
        }

        function renderWeeklyChart(chartType) {
            const currentData = appState.chartData[chartType]?.[appState.currentDate] || [];
            const colMap = appState.colMaps[chartType] || {};
            
            let html = `
                <div class="chart-container">
                    <div class="chart-header">
                        <div style="color: white;">POSITION</div>
                        <div style="color: white;">${chartType === 'songs' ? 'SONG' : chartType === 'artists' ? 'ARTIST' : 'ALBUM'}</div>
                        <div style="color: white;">UNITS</div>
                        <div style="color: white;">LAST WEEK</div>
                        <div style="color: white;">PEAK</div>
                        <div style="color: white;">WKS ON CHART</div>
                    </div>
            `;

            if (currentData.length === 0) {
                html += `
                    <div class="p-8 text-center text-gray-500">
                        <i class="fas fa-music text-4xl mb-4 text-gray-300"></i>
                        <p>No chart data available for the selected date.</p>
                    </div>
                `;
            } else {
                currentData.forEach((item, index) => {
                    const diff = formatDiff(item.diff);
                    const isFirst = index === 0;
                    
                    if (isFirst) {
                        html += `
                            <div class="first-position">
                                <div class="position-diff-cell">
                                    <div class="position-number">${item.position}</div>
                                    <div class="diff-indicator ${diff.type}">${diff.text}</div>
                                </div>
                                
                                <div class="image-cell">
                                    <div class="chart-image placeholder-art flex items-center justify-center bg-gray-200" id="top-image-${chartType}">
                                        <i class="fas ${chartType === 'songs' ? 'fa-music' : chartType === 'artists' ? 'fa-user' : 'fa-compact-disc'} text-gray-400"></i>
                                    </div>
                                </div>
                                
                                <div class="info-cell">
                                    <div class="track-name">${item.song || item.name || 'Unknown'}</div>
                                    <div class="artist-name">${item.artist}</div>
                                    ${chartType === 'songs' ? formatChartRun(getChartRunForItem(chartType, item.song)) : ''}
                                </div>
                                
                                <div class="units-cell">
                                    <div class="units-value">${formatUnits(item.units)}</div>
                                    ${item.totalUnits ? `<div class="total-units">${formatUnits(item.totalUnits)} total</div>` : ''}
                                    ${item.certification ? `<div class="certification">${item.certification}</div>` : ''}
                                </div>
                                
                                <div class="lastweek-cell">${item.lastWeek > 0 ? item.lastWeek : '-'}</div>
                                <div class="peak-cell">${item.peak}</div>
                                <div class="weeks-cell">${item.weeks}</div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="chart-row-weekly">
                                <div class="position-diff-cell">
                                    <div class="position-number">${item.position}</div>
                                    <div class="diff-indicator ${diff.type}">${diff.text}</div>
                                </div>
                                
                                <div class="image-cell">
                                    <div class="chart-image placeholder-art flex items-center justify-center bg-gray-200">
                                        <i class="fas ${chartType === 'songs' ? 'fa-music' : chartType === 'artists' ? 'fa-user' : 'fa-compact-disc'} text-gray-400"></i>
                                    </div>
                                </div>
                                
                                <div class="info-cell">
                                    <div class="track-name">${item.song || item.name || 'Unknown'}</div>
                                    <div class="artist-name">${item.artist}</div>
                                </div>
                                
                                <div class="units-cell">
                                    <div class="units-value">${formatUnits(item.units)}</div>
                                    ${item.totalUnits ? `<div class="total-units">${formatUnits(item.totalUnits)} total</div>` : ''}
                                    ${item.certification ? `<div class="certification">${item.certification}</div>` : ''}
                                </div>
                                
                                <div class="lastweek-cell">${item.lastWeek > 0 ? item.lastWeek : '-'}</div>
                                <div class="peak-cell">${item.peak}</div>
                                <div class="weeks-cell">${item.weeks}</div>
                            </div>
                        `;
                    }
                });
            }

            html += `</div>`;
            return html;
        }

        function renderYearEndOrGoatChart(chartType) {
            const dataKey = chartType.includes('yearEnd') ? appState.currentYear : 'allTime';
            const currentData = appState.chartData[chartType]?.[dataKey] || [];
            
            let html = `
                <div class="chart-container">
                    <div class="chart-header">
                        <div style="color: white;">POSITION</div>
                        <div style="color: white;">${chartType.includes('Songs') ? 'SONG' : chartType.includes('Artists') ? 'ARTIST' : 'ALBUM'}</div>
                        <div style="color: white;">TOTAL UNITS</div>
                        <div style="color: white;">CERTIFICATION</div>
                    </div>
            `;

            if (currentData.length === 0) {
                html += `
                    <div class="p-8 text-center text-gray-500">
                        <i class="fas fa-trophy text-4xl mb-4 text-gray-300"></i>
                        <p>No chart data available.</p>
                    </div>
                `;
            } else {
                currentData.forEach((item, index) => {
                    const isFirst = index === 0;
                    
                    if (isFirst) {
                        html += `
                            <div class="first-position">
                                <div class="position-number">${item.position}</div>
                                
                                <div class="image-cell">
                                    <div class="chart-image placeholder-art flex items-center justify-center bg-gray-200" id="top-image-${chartType}">
                                        <i class="fas ${chartType.includes('Songs') ? 'fa-music' : chartType.includes('Artists') ? 'fa-user' : 'fa-compact-disc'} text-gray-400"></i>
                                    </div>
                                </div>
                                
                                <div class="info-cell">
                                    <div class="track-name">${item.song || item.name || 'Unknown'}</div>
                                    <div class="artist-name">${item.artist}</div>
                                </div>
                                
                                <div class="units-cell">
                                    <div class="units-value">${formatUnits(item.totalUnits)}</div>
                                </div>
                                
                                <div class="certification">${item.certification || '-'}</div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="chart-row-with-image">
                                <div class="position-number">${item.position}</div>
                                
                                <div class="image-cell">
                                    <div class="chart-image-small placeholder-art flex items-center justify-center bg-gray-200">
                                        <i class="fas ${chartType.includes('Songs') ? 'fa-music' : chartType.includes('Artists') ? 'fa-user' : 'fa-compact-disc'} text-gray-400"></i>
                                    </div>
                                </div>
                                
                                <div class="chart-info-expanded">
                                    <div class="track-name">${item.song || item.name || 'Unknown'}</div>
                                    <div class="artist-name">${item.artist}</div>
                                </div>
                                
                                <div class="units-value">${formatUnits(item.totalUnits)}</div>
                                <div class="certification">${item.certification || '-'}</div>
                            </div>
                        `;
                    }
                });
            }

            html += `</div>`;
            return html;
        }

        function initializeDatePicker() {
            if (flatpickrInstance) {
                flatpickrInstance.destroy();
            }

            const datePicker = document.getElementById('datePicker');
            if (!datePicker) return;

            flatpickrInstance = flatpickr(datePicker, {
                defaultDate: appState.currentDate,
                dateFormat: "Y-m-d",
                maxDate: "today",
                disableMobile: true,
                onChange: function(selectedDates, dateStr) {
                    if (dateStr) {
                        changeDate(dateStr);
                    }
                }
            });

            if (appState.currentDate) {
                datePicker.value = appState.currentDate;
            }
        }

        function setupDateNavigation() {
            const prevBtn = document.getElementById('prevDate');
            const nextBtn = document.getElementById('nextDate');

            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    navigateToAdjacentDate(-1);
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    navigateToAdjacentDate(1);
                });
            }
        }

        function navigateToAdjacentDate(direction) {
            if (!appState.availableDates || appState.availableDates.length === 0) return;

            const currentIndex = appState.availableDates.indexOf(appState.currentDate);
            let newIndex = currentIndex + direction;

            if (newIndex < 0) newIndex = 0;
            if (newIndex >= appState.availableDates.length) newIndex = appState.availableDates.length - 1;

            if (newIndex !== currentIndex) {
                changeDate(appState.availableDates[newIndex]);
            }
        }

        function changeDate(newDate) {
            appState.currentDate = newDate;
            updateTop3Data(appState.activeChart);
            renderChartPage();
            loadAllCardImages();
        }

        function changeYear(newYear) {
            appState.currentYear = newYear;
            updateYearEndTop3Data(appState.activeChart);
            renderChartPage();
            loadAllCardImages();
        }

        function renderAllEntriesPage() {
            const html = `
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl md:text-3xl font-bold">All Chart Entries</h2>
                    <button onclick="navigateTo('home')" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                        <i class="fas fa-home"></i>
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="searchInput" class="search-input" placeholder="Search for songs, artists, or albums...">
                    </div>
                </div>

                <div id="allEntriesContent" class="space-y-6">
                    <div class="text-center py-8">
                        <div class="loader mx-auto mb-4"></div>
                        <p class="text-gray-500">Loading chart entries...</p>
                    </div>
                </div>

                <div class="bottom-nav flex justify-between items-center mt-8 pt-4 border-t border-gray-200">
                    <button onclick="navigateTo('home')" class="flex items-center text-accent hover:text-accent-dark transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Home
                    </button>
                </div>
            `;

            appContainer.innerHTML = html;

            setTimeout(() => {
                renderAllEntriesContent();
            }, 100);
        }

        function renderAllEntriesContent() {
            const contentContainer = document.getElementById('allEntriesContent');
            if (!contentContainer) return;

            let allEntries = [];
            ['songs', 'artists', 'albums'].forEach(chartType => {
                if (appState.allEntries[chartType]) {
                    allEntries = allEntries.concat(appState.allEntries[chartType].map(entry => ({
                        ...entry,
                        chartType: chartType
                    })));
                }
            });

            if (allEntries.length === 0) {
                contentContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                        <p>No chart entries available.</p>
                    </div>
                `;
                return;
            }

            allEntries.sort((a, b) => new Date(b.date) - new Date(a.date));

            let html = '';
            allEntries.forEach(entry => {
                const diff = formatDiff(entry.diff);
                const chartTitle = chartsConfig[entry.chartType]?.title || 'Chart';

                html += `
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="font-semibold">${entry.song || entry.name || 'Unknown'}</span>
                                <span class="text-gray-600 ml-2">by ${entry.artist}</span>
                            </div>
                            <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2 py-1 rounded">${chartTitle}</span>
                        </div>
                        
                        <div class="flex justify-between items-center text-sm text-gray-600">
                            <div>
                                <span class="font-medium">#${entry.position}</span>
                                <span class="mx-2">•</span>
                                <span>${entry.date}</span>
                                <span class="mx-2">•</span>
                                <span class="diff-indicator ${diff.type}">${diff.text}</span>
                            </div>
                            
                            <div>
                                <span>Peak: #${entry.peak || '-'}</span>
                                <span class="mx-2">•</span>
                                <span>Weeks: ${entry.weeks || '-'}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            contentContainer.innerHTML = html;

            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    filterAllEntries(this.value);
                });
            }
        }

        function filterAllEntries(searchTerm) {
            const contentContainer = document.getElementById('allEntriesContent');
            if (!contentContainer) return;

            let allEntries = [];
            ['songs', 'artists', 'albums'].forEach(chartType => {
                if (appState.allEntries[chartType]) {
                    allEntries = allEntries.concat(appState.allEntries[chartType].map(entry => ({
                        ...entry,
                        chartType: chartType
                    })));
                }
            });

            if (searchTerm.trim() === '') {
                allEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
            } else {
                const term = searchTerm.toLowerCase();
                allEntries = allEntries.filter(entry => 
                    (entry.song && entry.song.toLowerCase().includes(term)) ||
                    (entry.name && entry.name.toLowerCase().includes(term)) ||
                    (entry.artist && entry.artist.toLowerCase().includes(term)) ||
                    (entry.album && entry.album.toLowerCase().includes(term))
                );
            }

            let html = '';
            if (allEntries.length === 0) {
                html = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-search text-4xl mb-4"></i>
                        <p>No entries found matching your search.</p>
                    </div>
                `;
            } else {
                allEntries.forEach(entry => {
                    const diff = formatDiff(entry.diff);
                    const chartTitle = chartsConfig[entry.chartType]?.title || 'Chart';

                    html += `
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <span class="font-semibold">${entry.song || entry.name || 'Unknown'}</span>
                                    <span class="text-gray-600 ml-2">by ${entry.artist}</span>
                                </div>
                                <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2 py-1 rounded">${chartTitle}</span>
                            </div>
                            
                            <div class="flex justify-between items-center text-sm text-gray-600">
                                <div>
                                    <span class="font-medium">#${entry.position}</span>
                                    <span class="mx-2">•</span>
                                    <span>${entry.date}</span>
                                    <span class="mx-2">•</span>
                                    <span class="diff-indicator ${diff.type}">${diff.text}</span>
                                </div>
                                
                                <div>
                                    <span>Peak: #${entry.peak || '-'}</span>
                                    <span class="mx-2">•</span>
                                    <span>Weeks: ${entry.weeks || '-'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            contentContainer.innerHTML = html;
        }

        function renderChartBeatPage() {
            const html = `
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl md:text-3xl font-bold">Chart Beat</h2>
                    <button onclick="navigateTo('home')" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                        <i class="fas fa-home"></i>
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold">Hot 100 Stats</h3>
                            <i class="fas fa-music text-accent text-2xl"></i>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total Songs Charted</span>
                                <span class="font-semibold">${getTotalEntries('songs')}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Number Ones</span>
                                <span class="font-semibold">${getNumberOnes('songs')}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Most Weeks at #1</span>
                                <span class="font-semibold">${getMostWeeksAtOne('songs')}</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold">Artist 50 Stats</h3>
                            <i class="fas fa-user text-accent text-2xl"></i>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total Artists Charted</span>
                                <span class="font-semibold">${getTotalEntries('artists')}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Number Ones</span>
                                <span class="font-semibold">${getNumberOnes('artists')}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Most Weeks at #1</span>
                                <span class="font-semibold">${getMostWeeksAtOne('artists')}</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold">Album Stats</h3>
                            <i class="fas fa-compact-disc text-accent text-2xl"></i>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total Albums Charted</span>
                                <span class="font-semibold">${getTotalEntries('albums')}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Number Ones</span>
                                <span class="font-semibold">${getNumberOnes('albums')}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Most Weeks at #1</span>
                                <span class="font-semibold">${getMostWeeksAtOne('albums')}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                    <h3 class="text-xl font-bold mb-4">Recent Chart Activity</h3>
                    <div id="recentActivity" class="space-y-3">
                        <div class="text-center py-4">
                            <div class="loader mx-auto mb-2"></div>
                            <p class="text-gray-500">Loading recent activity...</p>
                        </div>
                    </div>
                </div>

                <div class="bottom-nav flex justify-between items-center mt-8 pt-4 border-t border-gray-200">
                    <button onclick="navigateTo('home')" class="flex items-center text-accent hover:text-accent-dark transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Home
                    </button>
                </div>
            `;

            appContainer.innerHTML = html;

            setTimeout(() => {
                renderRecentActivity();
            }, 100);
        }

        function getTotalEntries(chartType) {
            const entries = appState.allEntries[chartType] || [];
            const uniqueItems = new Set();
            entries.forEach(entry => {
                uniqueItems.add(entry.song || entry.name || 'Unknown');
            });
            return uniqueItems.size;
        }

        function getNumberOnes(chartType) {
            const entries = appState.allEntries[chartType] || [];
            const numberOnes = new Set();
            entries.forEach(entry => {
                if (entry.peak === 1) {
                    numberOnes.add(entry.song || entry.name || 'Unknown');
                }
            });
            return numberOnes.size;
        }

        function getMostWeeksAtOne(chartType) {
            const entries = appState.allEntries[chartType] || [];
            const weeksAtOne = {};
            
            entries.forEach(entry => {
                if (entry.weeksAt1 > 0) {
                    const key = entry.song || entry.name || 'Unknown';
                    weeksAtOne[key] = Math.max(weeksAtOne[key] || 0, entry.weeksAt1);
                }
            });
            
            const maxWeeks = Math.max(...Object.values(weeksAtOne), 0);
            return maxWeeks > 0 ? maxWeeks : '-';
        }

        function renderRecentActivity() {
            const activityContainer = document.getElementById('recentActivity');
            if (!activityContainer) return;

            let recentEntries = [];
            ['songs', 'artists', 'albums'].forEach(chartType => {
                if (appState.allEntries[chartType]) {
                    recentEntries = recentEntries.concat(appState.allEntries[chartType]
                        .slice(0, 10)
                        .map(entry => ({ ...entry, chartType })));
                }
            });

            recentEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
            recentEntries = recentEntries.slice(0, 10);

            if (recentEntries.length === 0) {
                activityContainer.innerHTML = '<p class="text-gray-500">No recent activity available.</p>';
                return;
            }

            let html = '';
            recentEntries.forEach(entry => {
                const diff = formatDiff(entry.diff);
                const chartTitle = chartsConfig[entry.chartType]?.title || 'Chart';
                const itemName = entry.song || entry.name || 'Unknown';

                html += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center">
                            <span class="diff-indicator ${diff.type} mr-3">${diff.text}</span>
                            <div>
                                <span class="font-medium">${itemName}</span>
                                <span class="text-gray-600 text-sm ml-2">by ${entry.artist}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium">#${entry.position}</div>
                            <div class="text-xs text-gray-500">${chartTitle}</div>
                        </div>
                    </div>
                `;
            });

            activityContainer.innerHTML = html;
        }

        function renderArtistPage() {
            if (!appState.currentArtist) {
                navigateTo('home');
                return;
            }

            const artistData = appState.artistStatsData[appState.currentArtist];
            const html = `
                <div class="artist-page">
                    <div class="mb-6 flex justify-between items-center">
                        <button onclick="navigateBack()" class="flex items-center text-accent hover:text-accent-dark transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Back
                        </button>
                        <button onclick="navigateTo('home')" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                            <i class="fas fa-home"></i>
                        </button>
                    </div>

                    <div class="artist-header">
                        <div class="artist-image-large placeholder-art flex items-center justify-center bg-gray-200">
                            <i class="fas fa-user text-gray-400 text-4xl"></i>
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold mb-2">${appState.currentArtist}</h2>
                            <p class="text-gray-600">Artist Statistics</p>
                        </div>
                    </div>

                    <div class="artist-stats">
                        <div class="stat-card">
                            <div class="stat-number">${artistData ? artistData['Hot 100 Songs'].count : 0}</div>
                            <div class="stat-label">Hot 100 Entries</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${artistData ? artistData['Top 100 Albums'].count : 0}</div>
                            <div class="stat-label">Album Chart Entries</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${artistData ? artistData['Artist 50'].count : 0}</div>
                            <div class="stat-label">Artist 50 Entries</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${artistData ? (artistData['Hot 100 Songs'].numberOnes + artistData['Top 100 Albums'].numberOnes + artistData['Artist 50'].numberOnes) : 0}</div>
                            <div class="stat-label">Total #1 Hits</div>
                        </div>
                    </div>

                    ${artistData ? `
                        <div class="artist-chart-section">
                            <h3 class="text-xl font-bold mb-4">Hot 100 Songs</h3>
                            <div class="space-y-2">
                                ${artistData['Hot 100 Songs'].entries.slice(0, 10).map(entry => `
                                    <div class="chart-item">
                                        <div class="flex-1">
                                            <div class="font-medium">${entry.item}</div>
                                        </div>
                                        <div class="text-right">
                                            <div>Peak: #${entry.peak}</div>
                                            <div class="text-sm text-gray-600">Weeks: ${entry.weeks}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="artist-chart-section">
                            <h3 class="text-xl font-bold mb-4">Top 100 Albums</h3>
                            <div class="space-y-2">
                                ${artistData['Top 100 Albums'].entries.slice(0, 10).map(entry => `
                                    <div class="chart-item">
                                        <div class="flex-1">
                                            <div class="font-medium">${entry.item}</div>
                                        </div>
                                        <div class="text-right">
                                            <div>Peak: #${entry.peak}</div>
                                            <div class="text-sm text-gray-600">Weeks: ${entry.weeks}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : '<p class="text-gray-500">No artist data available.</p>'}
                </div>
            `;

            appContainer.innerHTML = html;
        }

        // --- INICIALIZAÇÃO ---
        async function initializeApp() {
            showMessage('loading', 'Loading chart data...');
            
            try {
                const chartTypes = Object.keys(chartsConfig);
                const loadPromises = chartTypes.map(type => fetchChartData(type));
                
                await Promise.all(loadPromises);
                await fetchArtistStats();
                
                renderHomePage();
                loadAllCardImages();
            } catch (error) {
                console.error('Error initializing app:', error);
                showMessage('error', 'Failed to load chart data. Please try again.');
            }
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', initializeApp);

        document.getElementById('navAllEntries')?.addEventListener('click', () => navigateTo('allEntries'));
        document.getElementById('navChartBeat')?.addEventListener('click', () => navigateTo('chartBeat'));

        closeModal?.addEventListener('click', () => {
            itemDetailsModal.classList.remove('active');
        });

        itemDetailsModal?.addEventListener('click', (e) => {
            if (e.target === itemDetailsModal) {
                itemDetailsModal.classList.remove('active');
            }
        });

        // --- EXPORT FUNCTIONS FOR HTML ---
        window.navigateTo = navigateTo;
        window.navigateBack = navigateBack;
        window.changeDate = changeDate;
        window.changeYear = changeYear;
    </script>
</body>
</html>
